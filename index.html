<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADF sur ND</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.js"></script>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: pan-y;
            overflow-y: auto;
            overflow-x: hidden;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100vw;
            max-width: 100vw;
            box-sizing: border-box;
            padding: 20px 0;
        }
        .instructions {
            background-color: white;
            padding: 12px 0;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 100vw;
            max-width: 100vw;
            box-sizing: border-box;
            text-align: center;
            margin: 0;
        }
        .instructions p {
            margin: 8px 0;
            font-size: clamp(0.9rem, 2vw, 1rem);
            line-height: 1.4;
        }
        .consigne {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: left;
            width: 95%;
            max-width: 900px;
        }
        .consigne h3 {
            color: #856404;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .consigne p {
            margin: 5px 0;
            font-size: 0.95em;
            line-height: 1.4;
        }
        .astuce {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-style: italic;
            font-size: 0.9em;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            width: 100vw;
            max-width: 100vw;
            box-sizing: border-box;
            margin: 0;
        }
        button {
            padding: 12px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            flex: 1;
            min-width: 140px;
            max-width: 200px;
            touch-action: manipulation;
        }
        button:hover, button:active {
            background-color: #45a049;
        }
        .cap-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .cap-btn {
            width: 50px;
            height: 50px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
        }
        .cap-btn:hover {
            background-color: #1976D2;
        }
        .jeu-reponse-row {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            width: 100vw;
            max-width: 100vw;
            box-sizing: border-box;
            gap: 20px;
            margin: 0 auto;
        }
        #canvasContainer {
            flex: 3 1 0%;
            display: flex;
            justify-content: center;
            align-items: center;
            min-width: 200px;
            max-width: 1000px;
            position: relative;
            height: 400px; /* R√©duit la hauteur */
            border: 1px solid #ccc;
            background: white;
        }
        #reponsesBox {
            flex: 1 1 0%;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            padding: 18px 12px;
            min-width: 150px;
            max-width: 220px;
            font-size: 1.05em;
            color: #d63c3c;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-top: 30px;
        }
        @media (max-width: 900px) {
            .container {
                padding: 10px 0;
                gap: 10px;
            }
            .jeu-reponse-row {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
            #reponsesBox {
                margin-top: 8px;
                align-items: center;
                min-width: unset;
                max-width: 95vw;
                width: 95vw;
                font-size: 1em;
                text-align: center;
                order: 2; /* Met la bo√Æte de r√©ponses en dessous */
            }
            .consigne {
                padding: 12px;
                margin: 8px 10px;
            }
            #canvasContainer {
                height: 300px; /* Encore plus r√©duit sur mobile */
                max-width: 95vw;
                order: 1; /* Met le canvas en premier */
            }
            .controls {
                flex-direction: column;
                align-items: center;
                order: 3; /* Met les contr√¥les en dernier */
            }
            button {
                max-width: 95vw;
                width: 95vw;
            }
            .cap-controls {
                justify-content: center;
                width: 100%;
            }
            .astuce {
                font-size: 0.8em;
                padding: 10px;
            }
        }
        @media (max-width: 480px) {
            #canvasContainer {
                height: 250px; /* Encore plus petit sur tr√®s petits √©crans */
            }
            .container {
                gap: 8px;
            }
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: rgba(30,30,30,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal > div {
            background: #fff;
            padding: 24px 20px;
            border-radius: 12px;
            max-width: 350px;
            margin: 50px auto;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            text-align: left;
            position: relative;
        }
        .closeBtn {
            position: absolute; 
            top: 5px; 
            right: 7px; 
            background: transparent; 
            border: none; 
            font-size: 1.6em; 
            cursor: pointer;
        }
        .helpBtn {
            background: #eee; 
            color: #333;
            border: 1px solid #ccc; 
            border-radius: 5px; 
            font-size: 1rem; 
            padding: 4px 12px; 
            cursor: pointer;
            margin-bottom: 8px;
        }
        .help-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .contact-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 12px;
            color: #666;
            z-index: 100;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .contact-info a {
            color: #0066cc;
            text-decoration: none;
        }
        .contact-info a:hover {
            text-decoration: underline;
        }
        .hidden {
            display: none !important;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Navigation ADF sur ND</h1>
        
        <div class="consigne">
            <h3>üìã Consigne :</h3>
            <p><strong>D√©termine la position de l'avion, son cap, le gisement ainsi que les rel√®vements QDR et QDM √† partir de l'instrument.</strong></p>
            <p>D√©placez l'avion dans la zone bleue et modifiez son cap pour observer les changements dans les mesures.</p>
            
            <div class="astuce">
                <strong>Astuce :</strong><br>
                ‚Ä¢ Sur ordinateur : clic gauche pour d√©placer l'avion, clic droit pour modifier le cap<br>
                ‚Ä¢ Sur mobile : utilisez les boutons + et - pour modifier le cap, et touchez la zone bleue pour d√©placer l'avion<br>
                ‚Ä¢ La fl√®che double indique le QDM vers la balise de droite (NDB 2)<br>
                ‚Ä¢ La fl√®che simple indique le QDM vers la balise de gauche (NDB 1)
            </div>
        </div>

        <div class="controls">
            <div class="cap-controls">
                <button class="cap-btn" id="capMoins">-</button>
                <button class="cap-btn" id="capPlus">+</button>
            </div>
            <button id="randomBothBtn">Position/Cap Al√©atoire (3)</button>
            <button id="toggleReponseBtn">Afficher/Masquer R√©ponse</button>
        </div>
        
        <div class="jeu-reponse-row">
            <div id="canvasContainer">
                <div class="loading">Chargement des images...</div>
            </div>
            <div id="reponsesBox">QDR1 = ?<br>QDM1 = ?<br>GT1 = ?<br>CAP = ?<br>QDR2 = ?<br>QDM2 = ?<br>GT2 = ?</div>
        </div>
        
        <div class="help-buttons">
            <button id="showTermsBtn" class="helpBtn">‚ùì Explication des termes</button>
            <button id="showButtonsBtn" class="helpBtn">üîÑ Explication des boutons</button>
        </div>
        
        <div id="termsModal" class="modal">
            <div>
                <button class="closeBtn">&times;</button>
                <h2>Que signifient GT, QDM, QDR et Cap ?</h2>
                <ul>
                    <li><strong>GT :</strong> Gisement transmis par l'ADF, angle entre le nez de l'avion et la direction de la balise.</li>
                    <li><strong>QDM :</strong> Cap magn√©tique √† suivre pour aller vers la balise depuis la position de l'avion.</li>
                    <li><strong>QDR :</strong> Rel√®vement magn√©tique de la balise, cap √† suivre pour s'√©loigner de la balise.</li>
                    <li><strong>Cap :</strong> Direction du nez de l'avion par rapport au nord magn√©tique.</li>
                </ul>
            </div>
        </div>
        
        <div id="buttonsModal" class="modal">
            <div>
                <button class="closeBtn">&times;</button>
                <h2>√Ä quoi servent les boutons ?</h2>
                <ul>
                    <li><strong>Boutons + et - :</strong> Modifient le cap de l'avion</li>
                    <li><strong>Position/Cap Al√©atoire (3) :</strong> Change √† la fois la position et le cap de l'avion</li>
                    <li><strong>Afficher/Masquer R√©ponse :</strong> Montre ou cache les valeurs r√©elles</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="instructions">
        <p>Lyc√©e professionnel Roger Claustres - renaud.boulier@ac-clermont.fr</p>
    </div>
    
    <script>
        let imgNDcadre, imgNDmaquette, imgNDrose, imgtraicap;
        let flecheNDDouble, flecheNDSimple, imgNDB, imgPlane;
        let rose = 0;
        let QDR1, QDR3, QDM, QDM1, GT, GT1;
        let mx1, mx2, my1, my2, mmx, mmy;
        let rot;
        let reponse = false;
        let baliseLH, baliseRH, avion, avion1;
        let isMobile = false;
        let imagesLoaded = false;
        let imagesToLoad = 8;
        let imagesLoadedCount = 0;

        // Variables pour le contr√¥le continu du cap
        let rightMousePressed = false;
        let leftMousePressed = false;
        let lastUpdateTime = 0;
        const CAP_CHANGE_INTERVAL = 16;

        // Variables pour le contr√¥le mobile
        let capPlusPressed = false;
        let capMoinsPressed = false;

        // Variables pour le zoom et d√©placement
        let zoomScale = 1.0;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let lastTouchX, lastTouchY;
        let lastTouchDistance = 0;

        // Variable pour contr√¥ler le d√©placement de l'avion
        let aircraftMoving = false;

        // Variables pour la zone de d√©limitation des balises
        let baliseZone = {
            x: 0,
            y: 0,
            width: 0,
            height: 0,
            padding: 100
        };

        function preload() {
            // Chargement des images avec gestion d'erreur
            imgNDcadre = loadImage('NDcadre.png', imageLoaded, imageLoadError);
            imgNDmaquette = loadImage('NDmaquette.png', imageLoaded, imageLoadError);
            imgNDrose = loadImage('NDrose.png', imageLoaded, imageLoadError);
            flecheNDDouble = loadImage('NDDouble.png', imageLoaded, imageLoadError);
            flecheNDSimple = loadImage('NDSimple.png', imageLoaded, imageLoadError);
            imgNDB = loadImage('NDB.png', imageLoaded, imageLoadError);
            imgPlane = loadImage('plane.png', imageLoaded, imageLoadError);
            imgtraicap = loadImage('traicap.png', imageLoaded, imageLoadError);
        }

        function imageLoaded() {
            imagesLoadedCount++;
            console.log(`Image charg√©e (${imagesLoadedCount}/${imagesToLoad})`);
            if (imagesLoadedCount === imagesToLoad) {
                imagesLoaded = true;
                document.querySelector('.loading').style.display = 'none';
                console.log("Toutes les images sont charg√©es");
            }
        }

        function imageLoadError() {
            imagesLoadedCount++;
            console.log(`Erreur de chargement d'image (${imagesLoadedCount}/${imagesToLoad})`);
            if (imagesLoadedCount === imagesToLoad) {
                imagesLoaded = false;
                document.querySelector('.loading').textContent = 'Images non charg√©es - Mode graphique de secours';
                console.log("Certaines images n'ont pas pu √™tre charg√©es");
            }
        }

        function setup() {
            isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                      ('ontouchstart' in window) || 
                      (navigator.maxTouchPoints > 0);
            
            let canvasWidth, canvasHeight;
            if (isMobile) {
                canvasWidth = windowWidth * 0.95;
                canvasHeight = 300; // Hauteur fixe r√©duite pour mobile
            } else {
                canvasWidth = 1000;
                canvasHeight = 400;
            }
            
            let canvas = createCanvas(canvasWidth, canvasHeight);
            canvas.parent('canvasContainer');
            canvas.style('display', 'block');
            canvas.style('cursor', 'default');
            
            // Gestion des √©v√©nements tactiles - PLUS de preventDefault() qui bloque le scroll
            canvas.elt.addEventListener('touchstart', function(e) {
                // Ne pas bloquer le scroll - laisser le navigateur g√©rer
            }, { passive: true });
            
            canvas.elt.addEventListener('touchmove', function(e) {
                // Ne pas bloquer le scroll
            }, { passive: true });
            
            baliseLH = createVector(0, -10);
            baliseRH = createVector(0, -10);
            imageMode(CENTER);
            rectMode(CENTER);
            textAlign(CENTER, CENTER);
            
            setupButtonEvents();
            
            // Position initiale de l'avion
            let centerX = (min(600, 850) + max(600, 850)) / 2;
            let centerY = (min(183, 383) + max(183, 383)) / 2;
            mmx = centerX * zoomScale + offsetX;
            mmy = centerY * zoomScale + offsetY;
        }

        function setupButtonEvents() {
            const randomBothBtn = document.getElementById('randomBothBtn');
            const toggleReponseBtn = document.getElementById('toggleReponseBtn');
            const capPlusBtn = document.getElementById('capPlus');
            const capMoinsBtn = document.getElementById('capMoins');
            
            // Boutons de contr√¥le du cap
            if (capPlusBtn) {
                capPlusBtn.addEventListener('click', function() {
                    rose = (rose + 5) % 360;
                });
                capPlusBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    capPlusPressed = true;
                }, {passive: false});
                capPlusBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    capPlusPressed = false;
                }, {passive: false});
            }
            
            if (capMoinsBtn) {
                capMoinsBtn.addEventListener('click', function() {
                    rose = (rose - 5 + 360) % 360;
                });
                capMoinsBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    capMoinsPressed = true;
                }, {passive: false});
                capMoinsBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    capMoinsPressed = false;
                }, {passive: false});
            }
            
            if (randomBothBtn) {
                randomBothBtn.addEventListener('click', randomBoth);
                randomBothBtn.addEventListener('touchend', function(e) {e.preventDefault(); randomBoth();});
            }
            
            if (toggleReponseBtn) {
                toggleReponseBtn.addEventListener('click', toggleReponse);
                toggleReponseBtn.addEventListener('touchend', function(e) {e.preventDefault(); toggleReponse();});
            }
            
            const showTermsBtn = document.getElementById('showTermsBtn');
            const showButtonsBtn = document.getElementById('showButtonsBtn');
            
            if (showTermsBtn) {
                showTermsBtn.addEventListener('click', function() {
                    document.getElementById('termsModal').classList.add('active');
                });
            }
            
            if (showButtonsBtn) {
                showButtonsBtn.addEventListener('click', function() {
                    document.getElementById('buttonsModal').classList.add('active');
                });
            }
            
            document.querySelectorAll('.closeBtn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').classList.remove('active');
                });
            });
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
        }

        function draw() {
            background(255);
            
            updateCapContinuous();

            if (!isMobile && leftMousePressed) {
                updateAircraftPosition();
            }

            push();
            translate(offsetX, offsetY);
            scale(zoomScale);

            let NDX, NDY, NDBX1, NDBY1, NDBX2, NDBY2;
            
            if (isMobile) {
                NDX = width * 0.3;
                NDY = height * 0.4; // Ajust√© pour la hauteur r√©duite
                NDBX1 = width * 0.7;
                NDBY1 = height * 0.3;
                NDBX2 = width * 0.7;
                NDBY2 = height * 0.6;
            } else {
                NDX = 200;
                NDY = 183;
                NDBX1 = 600;
                NDBY1 = 183;
                NDBX2 = 850;
                NDBY2 = 383;
            }

            calculateBaliseZone(NDBX1, NDBY1, NDBX2, NDBY2);
            drawBaliseZone();

            if (mmx === undefined || mmy === undefined) {
                let centerX = baliseZone.x + baliseZone.width / 2;
                let centerY = baliseZone.y + baliseZone.height / 2;
                mmx = centerX * zoomScale + offsetX;
                mmy = centerY * zoomScale + offsetY;
            }

            let cadreSize, roseSize, traicapSize;
            if (isMobile) {
                cadreSize = min(width, height) * 0.35; // R√©duit pour s'adapter
                roseSize = min(width, height) * 0.3;
                traicapSize = min(width, height) * 0.35;
            } else {
                cadreSize = 368;
                roseSize = 368;
                traicapSize = 368;
            }

            drawMainElements(NDX, NDY, cadreSize, roseSize, traicapSize, NDBX1, NDBY1, NDBX2, NDBY2);
            calculateNavigation(NDX, NDY, NDBX1, NDBY1, NDBX2, NDBY2);
            drawAircraft(NDX);
            drawBaliseNumbers(NDBX1, NDBY1, NDBX2, NDBY2);

            pop();
            updateAnswers();
        }

        function drawBaliseNumbers(NDBX1, NDBY1, NDBX2, NDBY2) {
            // Num√©ros en ROUGE sur les balises
            fill(255, 0, 0); // Rouge
            textSize(isMobile ? 14 : 20); // L√©g√®rement plus petit sur mobile
            textAlign(CENTER, CENTER);
            textStyle(BOLD);
            text("1", NDBX1, NDBY1);
            text("2", NDBX2, NDBY2);
            textAlign(LEFT, CENTER);
            textStyle(NORMAL);
        }

        // ... (le reste du code JavaScript reste identique) ...

        function touchStarted(event) {
            if (isMobile) {
                const touchX = event.touches[0].clientX;
                const touchY = event.touches[0].clientY;
                
                // V√©rifier si le touch est dans le canvas
                const canvas = document.querySelector('canvas');
                const rect = canvas.getBoundingClientRect();
                
                if (touchX >= rect.left && touchX <= rect.right && 
                    touchY >= rect.top && touchY <= rect.bottom) {
                    
                    let adjustedTouchX = (touchX - offsetX - rect.left) / zoomScale;
                    let adjustedTouchY = (touchY - offsetY - rect.top) / zoomScale;
                    
                    if (isInBaliseZone(adjustedTouchX, adjustedTouchY)) {
                        aircraftMoving = true;
                        mmx = touchX - rect.left;
                        mmy = touchY - rect.top;
                        
                        if (touches.length === 1) {
                            isDragging = true;
                            lastTouchX = touchX;
                            lastTouchY = touchY;
                        }
                    }
                }
            }
            return true; // Permettre le scroll
        }

        function touchMoved(event) {
            if (isMobile && aircraftMoving) {
                const touchX = event.touches[0].clientX;
                const touchY = event.touches[0].clientY;
                
                const canvas = document.querySelector('canvas');
                const rect = canvas.getBoundingClientRect();
                
                let targetX = touchX - rect.left;
                let targetY = touchY - rect.top;
                
                let adjustedTargetX = (targetX - offsetX) / zoomScale;
                let adjustedTargetY = (targetY - offsetY) / zoomScale;
                
                if (isInBaliseZone(adjustedTargetX, adjustedTargetY)) {
                    mmx = targetX;
                    mmy = targetY;
                }
            }
            return true; // Permettre le scroll
        }

        // ... (le reste des fonctions reste identique) ...

    </script>
</body>
</html>
