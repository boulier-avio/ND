<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"> 
    <title>BOULIER gisement ADF sur ND</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            background: white;
        }
        .mobile-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        .control-btn {
            width: 60px;
            height: 60px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            margin: 5px;
            touch-action: manipulation;
        }
        #debug {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.8);
            padding: 5px;
            font-size: 12px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="mobile-controls">
        <button class="control-btn" id="capPlus">+</button>
        <button class="control-btn" id="capMoins">-</button>
    </div>
    <div id="debug"></div>

    <script>
        let imgNDcadre, imgNDmaquette, imgNDrose, imgADF1, imgADF3;
        let flecheNDDouble, flecheNDSimple, imgNDB, imgPlane;
        let rose = 0;
        let QDR1, QDR3, QDM, QDM1, GT, GT1;
        let mx1, mx2, my1, my2, mmx, mmy;
        let rot;
        let reponse = false;
        let baliseLH, baliseRH, avion, avion1;
        let isMobile = false;
        let imagesLoaded = false;
        
        // Variables pour le contrôle continu du cap
        let rightMousePressed = false;
        let lastUpdateTime = 0;
        const CAP_CHANGE_INTERVAL = 16; // ~60fps

        // Fonction pour créer des images de remplacement si les vraies ne chargent pas
        function createPlaceholderImages() {
            // Créer un canvas pour générer des images de placeholder
            let placeholder = createGraphics(100, 100);
            placeholder.background(200);
            placeholder.fill(100);
            placeholder.textAlign(CENTER, CENTER);
            placeholder.text("IMG", 50, 50);
            
            imgNDcadre = placeholder;
            imgNDmaquette = placeholder;
            imgNDrose = placeholder;
            imgADF1 = placeholder;
            imgADF3 = placeholder;
            flecheNDDouble = placeholder;
            flecheNDSimple = placeholder;
            imgNDB = placeholder;
            imgPlane = placeholder;
            
            imagesLoaded = true;
        }

        function preload() {
            try {
                imgNDcadre = loadImage('NDcadre.png', 
                    () => console.log('NDcadre loaded'),
                    () => { console.log('NDcadre failed'); createPlaceholderImages(); }
                );
                imgNDmaquette = loadImage('NDmaquette.png');
                imgNDrose = loadImage('NDrose.png');
                imgADF1 = loadImage('ADF1.png');
                imgADF3 = loadImage('ADF3.png');
                flecheNDDouble = loadImage('NDDouble.png');
                flecheNDSimple = loadImage('NDSimple.png');
                imgNDB = loadImage('NDB.png');
                imgPlane = loadImage('plane.png');
                imagesLoaded = true;
            } catch (e) {
                console.log('Error loading images:', e);
                createPlaceholderImages();
            }
        }

        function setup() {
            // Détection mobile améliorée
            isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                      ('ontouchstart' in window) || 
                      (navigator.maxTouchPoints > 0);
            
            console.log('Mobile detection:', isMobile);
            
            // Créer le canvas en plein écran
            let canvas = createCanvas(windowWidth, windowHeight);
            canvas.style('display', 'block');
            
            // Position initiale de l'avion
            mmx = width / 2;
            mmy = height / 2;
            baliseLH = createVector(0, -10);
            baliseRH = createVector(0, -10);
            imageMode(CENTER);
            rectMode(CENTER);
            textAlign(LEFT, CENTER);
            
            // Configuration des boutons mobiles
            if (isMobile) {
                let capPlusPressed = false;
                let capMoinsPressed = false;
                
                document.getElementById('capPlus').addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    capPlusPressed = true;
                }, {passive: false});
                
                document.getElementById('capPlus').addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    capPlusPressed = false;
                }, {passive: false});
                
                document.getElementById('capMoins').addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    capMoinsPressed = true;
                }, {passive: false});
                
                document.getElementById('capMoins').addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    capMoinsPressed = false;
                }, {passive: false});
                
                // Mise à jour continue du cap pour mobile
                setInterval(() => {
                    if (capPlusPressed) rose = (rose + 2) % 360;
                    if (capMoinsPressed) rose = (rose - 2 + 360) % 360;
                }, 16);
                
                // Cacher les boutons sur desktop
                document.querySelector('.mobile-controls').style.display = 'block';
            } else {
                document.querySelector('.mobile-controls').style.display = 'none';
            }
        }

        function draw() {
            background(255);
            
            // Debug info
            if (isMobile) {
                document.getElementById('debug').innerHTML = 
                    `Mobile: ${isMobile}<br>Touch: ${touches.length}<br>Cap: ${rose}°`;
            }

            // Mise à jour continue du cap si clic droit maintenu (desktop seulement)
            if (!isMobile && rightMousePressed) {
                let currentTime = millis();
                if (currentTime - lastUpdateTime > CAP_CHANGE_INTERVAL) {
                    rose = (rose + 1) % 360;
                    lastUpdateTime = currentTime;
                }
            }

            // Positions adaptatives
            let NDX, NDY, NDBX1, NDBY1, NDBX2, NDBY2;
            
            if (isMobile) {
                // Layout vertical pour mobile
                NDX = width * 0.3;
                NDY = height * 0.25;
                NDBX1 = width * 0.7;
                NDBY1 = height * 0.25;
                NDBX2 = width * 0.7;
                NDBY2 = height * 0.5;
            } else {
                // Layout horizontal pour desktop
                NDX = 183;
                NDY = 183;
                NDBX1 = 553;
                NDBY1 = 183;
                NDBX2 = 753;
                NDBY2 = 383;
            }

            // Contrôle de l'avion
            if (isMobile) {
                // Sur mobile, l'avion suit le doigt
                if (touches.length > 0) {
                    mmx = touches[0].x;
                    mmy = touches[0].y;
                }
            } else {
                // Sur desktop, l'avion suit la souris dans la zone de droite
                if (mouseX > NDX + 100) {
                    mmx = mouseX;
                    mmy = mouseY;
                }
            }

            // Tailles adaptatives
            let cadreSize = isMobile ? min(width, height) * 0.35 : 368;
            let roseSize = isMobile ? min(width, height) * 0.25 : 271;

            // Affichage des éléments principaux
            if (imagesLoaded) {
                image(imgNDcadre, NDX, NDY, cadreSize, cadreSize);
                image(imgNDmaquette, NDX, NDY+18, 31, 27);
                image(imgADF1, 60, 311, 51, 28);
                image(imgADF3, 300, 311, 54, 34);

                push();
                translate(NDX, NDY+14);  
                rotate(radians(-rose));
                image(imgNDrose, 0, 0, roseSize, roseSize); 
                pop();
                
                push();
                translate(NDX, NDY+15);
                rotate(radians(QDM));  
                image(flecheNDDouble, 0, 0, 17, 231);
                pop();

                push();
                translate(NDX, NDY+15);
                rotate(radians(QDM1));  
                image(flecheNDSimple, 0, 0, 20, 231);
                pop();

                image(imgNDB, NDBX1, NDBY1);
                image(imgNDB, NDBX2, NDBY2);
            }

            // Marqueur fixe
            stroke(233, 255, 3);
            strokeWeight(2);
            line(NDX, NDY-140, NDX, NDY-120);
            noStroke();

            // Calculs de navigation
            calculateNavigation(NDX, NDY, NDBX1, NDBY1, NDBX2, NDBY2);

            // Affichage de l'avion
            if ((isMobile && touches.length > 0) || (!isMobile && mouseX > NDX + 100)) {
                if (!isMobile) noCursor();
                push();
                translate(mmx, mmy);
                rotate(radians(rose));
                if (imagesLoaded) {
                    image(imgPlane, 1, 5);
                } else {
                    // Fallback si image non chargée
                    fill(255, 0, 0);
                    triangle(-15, -10, 15, -10, 0, -25);
                    rect(-5, 0, 10, 15);
                }
                pop();
            } else {
                if (!isMobile) cursor(ARROW);
            }

            // Interface utilisateur
            drawInterface();
        }

        function calculateNavigation(NDX, NDY, NDBX1, NDBY1, NDBX2, NDBY2) {
            // Calcul pour la première balise
            mx1 = mmx - NDBX1;
            my1 = mmy - NDBY1;
            avion = createVector(mx1, my1);
            
            let angle1 = atan2(my1, mx1);
            QDR1 = degrees(angle1);
            if (QDR1 < 0) QDR1 += 360;
            
            QDM1 = (QDR1 + 180) % 360;
            GT = (QDM1 - rose + 360) % 360;

            // Calcul pour la deuxième balise
            mx2 = mmx - NDBX2;
            my2 = mmy - NDBY2;
            avion1 = createVector(mx2, my2);
            
            let angle2 = atan2(my2, mx2);
            QDR3 = degrees(angle2);
            if (QDR3 < 0) QDR3 += 360;
            
            QDM = (QDR3 + 180) % 360;
            GT1 = (QDM - rose + 360) % 360;
        }

        function drawInterface() {
            // Position adaptative du panneau d'info
            let infoX = isMobile ? 10 : 5;
            let infoY = isMobile ? height * 0.65 : 400;
            let textStep = 15;

            // Bouton infos
            fill(0);
            rect(infoX + 45, infoY + 130, 90, 25);
            fill(255);
            textSize(12);
            text("infos", infoX + 45, infoY + 130);

            // Affichage des valeurs
            fill(0);
            textSize(isMobile ? 11 : 12);
            
            if (reponse) {
                text("QDR1 = " + round(QDR1), infoX + 55, infoY);
                text("QDM1 = " + round(QDM1), infoX + 55, infoY + textStep);
                text("GT1  = " + round(GT), infoX + 55, infoY + textStep * 2);
                text("CAP  = " + round(rose), infoX + 55, infoY + textStep * 3);
                text("QDR2 = " + round(QDR3), infoX + 55, infoY + textStep * 4);
                text("QDM2 = " + round(QDM), infoX + 55, infoY + textStep * 5);
                text("GT2  = " + round(GT1), infoX + 55, infoY + textStep * 6);
            } else {
                text("QDR1 = ---", infoX + 55, infoY);
                text("QDM1 = ---", infoX + 55, infoY + textStep);
                text("GT1  = ---", infoX + 55, infoY + textStep * 2);
                text("CAP  = " + round(rose), infoX + 55, infoY + textStep * 3);
                text("QDR2 = ---", infoX + 55, infoY + textStep * 4);
                text("QDM2 = ---", infoX + 55, infoY + textStep * 5);
                text("GT2  = ---", infoX + 55, infoY + textStep * 6);
            }

            // Labels
            //text("QDR1 =", infoX + 5, infoY);
            //text("QDM1 =", infoX + 5, infoY + textStep);
            //text("GT1  =", infoX + 5, infoY + textStep * 2);
            //text("CAP  =", infoX + 5, infoY + textStep * 3);
            //text("QDR2 =", infoX + 5, infoY + textStep * 4);
            //text("QDM2 =", infoX + 5, infoY + textStep * 5);
          //  text("GT2  =", infoX + 5, infoY + textStep * 6);

            // Instructions mobiles
            if (isMobile) {
                fill(0);
                textSize(14);
                textAlign(CENTER);
                text("Touchez l'écran pour déplacer l'avion", width/2, 50);
                textAlign(LEFT);
            }

            // Aide au survol (desktop seulement)
            if (!isMobile && mouseX > infoX && mouseX < infoX + 95 && 
                mouseY > infoY + 110 && mouseY < infoY + 135) {
                fill(255, 0, 0);
                text("Clic droit MAIN TENU: changer cap", infoX + 6, infoY + 150);
                text("Touche 1: afficher valeurs", infoX + 6, infoY + 165);
            }
        }

        function mousePressed() {
            if (!isMobile && mouseButton === RIGHT) {
                rightMousePressed = true;
                lastUpdateTime = millis();
                return false;
            }
            return false;
        }

        function mouseReleased() {
            if (!isMobile && mouseButton === RIGHT) {
                rightMousePressed = false;
                return false;
            }
            return false;
        }

        function keyPressed() {
            if (key === '1') {
                reponse = !reponse;
            }
        }

        function touchStarted() {
            // Empêche les comportements par défaut du navigateur
            return false;
        }

        function touchMoved() {
            // Empêche le défilement
            return false;
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }

        // Empêche tous les menus contextuels
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // Empêche le zoom tactile
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });

        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
        });

        document.addEventListener('gestureend', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
