<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADF sur ND</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.js"></script>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: pan-y; /* Permet le d√©filement vertical */
            overflow-y: auto; /* Assure le d√©filement */
            overflow-x: hidden;
            /* Suppression de height: 100vh qui peut causer des probl√®mes */
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100vw;
            max-width: 100vw;
            box-sizing: border-box;
            padding: 0;
            /* Suppression de height: 100vh */
        }
        .instructions {
            background-color: white;
            padding: 12px 0;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 100vw;
            max-width: 100vw;
            box-sizing: border-box;
            text-align: center;
            margin: 0;
        }
        .consigne {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: left;
            width: 95%;
            max-width: 900px;
        }
        .consigne h3 {
            color: #856404;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .consigne p {
            margin: 5px 0;
            font-size: 0.95em;
            line-height: 1.4;
        }
        .astuce {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-style: italic;
            font-size: 0.9em;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            width: 100vw;
            max-width: 100vw;
            box-sizing: border-box;
            margin: 0;
        }
        button {
            padding: 12px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            flex: 1;
            min-width: 140px;
            max-width: 200px;
            touch-action: manipulation;
        }
        button:hover, button:active {
            background-color: #45a049;
        }
        .cap-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .cap-btn {
            width: 50px;
            height: 50px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
        }
        .cap-btn:hover {
            background-color: #1976D2;
        }
        .jeu-reponse-row {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            width: 100vw;
            max-width: 100vw;
            box-sizing: border-box;
            gap: 20px;
            margin: 0 auto;
        }
        #canvasContainer {
            flex: 3 1 0%;
            display: flex;
            justify-content: center;
            align-items: center;
            min-width: 200px;
            max-width: 1000px;
            position: relative;
            height: 500px; /* Hauteur fixe pour desktop */
            border: 1px solid #ccc;
            background: white;
        }
        #reponsesBox {
            flex: 1 1 0%;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            padding: 18px 12px;
            min-width: 150px;
            max-width: 220px;
            font-size: 1.05em;
            color: #d63c3c;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-top: 30px;
        }
        @media (max-width: 900px) {
            .jeu-reponse-row {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
            #reponsesBox {
                margin-top: 8px;
                align-items: center;
                min-width: unset;
                max-width: 95vw;
                width: 95vw;
                font-size: 1em;
                text-align: center;
            }
            .consigne {
                padding: 12px;
                margin: 8px 10px;
            }
            #canvasContainer {
                height: 400px; /* Hauteur r√©duite pour mobile */
                max-width: 95vw;
            }
            .controls {
                flex-direction: column;
                align-items: center;
            }
            button {
                max-width: 95vw;
                width: 95vw;
            }
            .cap-controls {
                justify-content: center;
                width: 100%;
            }
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: rgba(30,30,30,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal > div {
            background: #fff;
            padding: 24px 20px;
            border-radius: 12px;
            max-width: 350px;
            margin: 50px auto;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            text-align: left;
            position: relative;
        }
        .closeBtn {
            position: absolute; 
            top: 5px; 
            right: 7px; 
            background: transparent; 
            border: none; 
            font-size: 1.6em; 
            cursor: pointer;
        }
        .helpBtn {
            background: #eee; 
            color: #333;
            border: 1px solid #ccc; 
            border-radius: 5px; 
            font-size: 1rem; 
            padding: 4px 12px; 
            cursor: pointer;
            margin-bottom: 8px;
        }
        .help-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .contact-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 12px;
            color: #666;
            z-index: 100;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .contact-info a {
            color: #0066cc;
            text-decoration: none;
        }
        .contact-info a:hover {
            text-decoration: underline;
        }
        .hidden {
            display: none !important;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Navigation ADF sur ND</h1>
        
        <div class="consigne">
            <h3>üìã Consigne :</h3>
            <p><strong>D√©termine la position de l'avion, son cap, le gisement ainsi que les rel√®vements QDR et QDM √† partir de l'instrument.</strong></p>
            <p>D√©placez l'avion dans la zone bleue et modifiez son cap pour observer les changements dans les mesures.</p>
            
            <div class="astuce">
                <strong>Astuce :</strong><br>
                ‚Ä¢ Sur ordinateur : clic gauche pour d√©placer l'avion, clic droit pour modifier le cap<br>
                ‚Ä¢ Sur mobile : utilisez les boutons + et - pour modifier le cap, et touchez la zone bleue pour d√©placer l'avion<br>
                ‚Ä¢ La fl√®che double indique le QDM vers la balise de droite (NDB 2)<br>
                ‚Ä¢ La fl√®che simple indique le QDM vers la balise de gauche (NDB 1)
            </div>
        </div>

        <div class="controls">
            <div class="cap-controls">
                <button class="cap-btn" id="capMoins">-</button>
                <button class="cap-btn" id="capPlus">+</button>
            </div>
            <button id="randomBothBtn">Position/Cap Al√©atoire (3)</button>
            <button id="toggleReponseBtn">Afficher/Masquer R√©ponse</button>
        </div>
        
        <div class="jeu-reponse-row">
            <div id="canvasContainer">
                <div class="loading">Chargement des images...</div>
            </div>
            <div id="reponsesBox">QDR1 = ?<br>QDM1 = ?<br>GT1 = ?<br>CAP = ?<br>QDR2 = ?<br>QDM2 = ?<br>GT2 = ?</div>
        </div>
        
        <div class="help-buttons">
            <button id="showTermsBtn" class="helpBtn">‚ùì Explication des termes</button>
            <button id="showButtonsBtn" class="helpBtn">üîÑ Explication des boutons</button>
        </div>
        
        <div id="termsModal" class="modal">
            <div>
                <button class="closeBtn">&times;</button>
                <h2>Que signifient GT, QDM, QDR et Cap ?</h2>
                <ul>
                    <li><strong>GT :</strong> Gisement transmis par l'ADF, angle entre le nez de l'avion et la direction de la balise.</li>
                    <li><strong>QDM :</strong> Cap magn√©tique √† suivre pour aller vers la balise depuis la position de l'avion.</li>
                    <li><strong>QDR :</strong> Rel√®vement magn√©tique de la balise, cap √† suivre pour s'√©loigner de la balise.</li>
                    <li><strong>Cap :</strong> Direction du nez de l'avion par rapport au nord magn√©tique.</li>
                </ul>
            </div>
        </div>
        
        <div id="buttonsModal" class="modal">
            <div>
                <button class="closeBtn">&times;</button>
                <h2>√Ä quoi servent les boutons ?</h2>
                <ul>
                    <li><strong>Boutons + et - :</strong> Modifient le cap de l'avion</li>
                    <li><strong>Position/Cap Al√©atoire (3) :</strong> Change √† la fois la position et le cap de l'avion</li>
                    <li><strong>Afficher/Masquer R√©ponse :</strong> Montre ou cache les valeurs r√©elles</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="instructions">
        <p>Lyc√©e professionnel Roger Claustres - renaud.boulier@ac-clermont.fr</p>
    </div>
    
    <script>
        let imgNDcadre, imgNDmaquette, imgNDrose, imgtraicap;
        let flecheNDDouble, flecheNDSimple, imgNDB, imgPlane;
        let rose = 0;
        let QDR1, QDR3, QDM, QDM1, GT, GT1;
        let mx1, mx2, my1, my2, mmx, mmy;
        let rot;
        let reponse = false;
        let baliseLH, baliseRH, avion, avion1;
        let isMobile = false;
        let imagesLoaded = false;
        let imagesToLoad = 8;
        let imagesLoadedCount = 0;

        // Variables pour le contr√¥le continu du cap
        let rightMousePressed = false;
        let leftMousePressed = false;
        let lastUpdateTime = 0;
        const CAP_CHANGE_INTERVAL = 16;

        // Variables pour le contr√¥le mobile
        let capPlusPressed = false;
        let capMoinsPressed = false;

        // Variables pour le zoom et d√©placement
        let zoomScale = 1.0;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let lastTouchX, lastTouchY;
        let lastTouchDistance = 0;

        // Variable pour contr√¥ler le d√©placement de l'avion
        let aircraftMoving = false;

        // Variables pour la zone de d√©limitation des balises
        let baliseZone = {
            x: 0,
            y: 0,
            width: 0,
            height: 0,
            padding: 100
        };

        function preload() {
            // Chargement des images avec gestion d'erreur
            imgNDcadre = loadImage('NDcadre.png', imageLoaded, imageLoadError);
            imgNDmaquette = loadImage('NDmaquette.png', imageLoaded, imageLoadError);
            imgNDrose = loadImage('NDrose.png', imageLoaded, imageLoadError);
            flecheNDDouble = loadImage('NDDouble.png', imageLoaded, imageLoadError);
            flecheNDSimple = loadImage('NDSimple.png', imageLoaded, imageLoadError);
            imgNDB = loadImage('NDB.png', imageLoaded, imageLoadError);
            imgPlane = loadImage('plane.png', imageLoaded, imageLoadError);
            imgtraicap = loadImage('traicap.png', imageLoaded, imageLoadError);
        }

        
        }

        function imageLoadError() {
            imagesLoadedCount++;
            console.log(`Erreur de chargement d'image (${imagesLoadedCount}/${imagesToLoad})`);
            if (imagesLoadedCount === imagesToLoad) {
                imagesLoaded = false;
                document.querySelector('.loading').textContent = 'Images non charg√©es - Mode graphique de secours';
                console.log("Certaines images n'ont pas pu √™tre charg√©es");
            }
        }

        function setup() {
            isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                      ('ontouchstart' in window) || 
                      (navigator.maxTouchPoints > 0);
            
            let canvasWidth, canvasHeight;
            if (isMobile) {
                canvasWidth = windowWidth * 0.95;
                canvasHeight = 400; // Hauteur fixe pour mobile
            } else {
                canvasWidth = 1000;
                canvasHeight = 500;
            }
            
            let canvas = createCanvas(canvasWidth, canvasHeight);
            canvas.parent('canvasContainer');
            canvas.style('display', 'block');
            canvas.style('cursor', 'default');
            
            // Gestion des √©v√©nements tactiles - plus permissive
            canvas.elt.addEventListener('touchstart', function(e) {
                if (isInBaliseZone((e.touches[0].clientX - offsetX) / zoomScale, 
                                  (e.touches[0].clientY - offsetY) / zoomScale)) {
                    // Ne pas emp√™cher le d√©filement si on n'est pas en train de d√©placer l'avion
                    if (aircraftMoving) {
                        e.preventDefault();
                    }
                }
            }, { passive: false });
            
            canvas.elt.addEventListener('touchmove', function(e) {
                if (aircraftMoving) {
                    e.preventDefault();
                }
                // Permettre le d√©filement si on ne d√©place pas l'avion
            }, { passive: false });
            
            canvas.elt.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
            
            canvas.elt.addEventListener('gesturechange', function(e) {
                e.preventDefault();
            });
            
            canvas.elt.addEventListener('gestureend', function(e) {
                e.preventDefault();
            });
            
            baliseLH = createVector(0, -10);
            baliseRH = createVector(0, -10);
            imageMode(CENTER);
            rectMode(CENTER);
            textAlign(CENTER, CENTER);
            
            setupButtonEvents();
            
            // Position initiale de l'avion
            let centerX = (min(600, 850) + max(600, 850)) / 2;
            let centerY = (min(183, 383) + max(183, 383)) / 2;
            mmx = centerX * zoomScale + offsetX;
            mmy = centerY * zoomScale + offsetY;
        }

        function setupButtonEvents() {
            const randomBothBtn = document.getElementById('randomBothBtn');
            const toggleReponseBtn = document.getElementById('toggleReponseBtn');
            const capPlusBtn = document.getElementById('capPlus');
            const capMoinsBtn = document.getElementById('capMoins');
            
            // Boutons de contr√¥le du cap
            if (capPlusBtn) {
                capPlusBtn.addEventListener('click', function() {
                    rose = (rose + 5) % 360;
                });
                capPlusBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    capPlusPressed = true;
                }, {passive: false});
                capPlusBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    capPlusPressed = false;
                }, {passive: false});
            }
            
            if (capMoinsBtn) {
                capMoinsBtn.addEventListener('click', function() {
                    rose = (rose - 5 + 360) % 360;
                });
                capMoinsBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    capMoinsPressed = true;
                }, {passive: false});
                capMoinsBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    capMoinsPressed = false;
                }, {passive: false});
            }
            
            if (randomBothBtn) {
                randomBothBtn.addEventListener('click', randomBoth);
                randomBothBtn.addEventListener('touchend', function(e) {e.preventDefault(); randomBoth();});
            }
            
            if (toggleReponseBtn) {
                toggleReponseBtn.addEventListener('click', toggleReponse);
                toggleReponseBtn.addEventListener('touchend', function(e) {e.preventDefault(); toggleReponse();});
            }
            
            const showTermsBtn = document.getElementById('showTermsBtn');
            const showButtonsBtn = document.getElementById('showButtonsBtn');
            
            if (showTermsBtn) {
                showTermsBtn.addEventListener('click', function() {
                    document.getElementById('termsModal').classList.add('active');
                });
            }
            
            if (showButtonsBtn) {
                showButtonsBtn.addEventListener('click', function() {
                    document.getElementById('buttonsModal').classList.add('active');
                });
            }
            
            document.querySelectorAll('.closeBtn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').classList.remove('active');
                });
            });
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
        }

        function draw() {
            background(255);
            
            updateCapContinuous();

            if (!isMobile && leftMousePressed) {
                updateAircraftPosition();
            }

            push();
            translate(offsetX, offsetY);
            scale(zoomScale);

            let NDX, NDY, NDBX1, NDBY1, NDBX2, NDBY2;
            
            if (isMobile) {
                NDX = width * 0.3;
                NDY = height * 0.3;
                NDBX1 = width * 0.7;
                NDBY1 = height * 0.25;
                NDBX2 = width * 0.7;
                NDBY2 = height * 0.5;
            } else {
                NDX = 200;
                NDY = 183;
                NDBX1 = 600;
                NDBY1 = 183;
                NDBX2 = 850;
                NDBY2 = 383;
            }

            calculateBaliseZone(NDBX1, NDBY1, NDBX2, NDBY2);
            drawBaliseZone();

            if (mmx === undefined || mmy === undefined) {
                let centerX = baliseZone.x + baliseZone.width / 2;
                let centerY = baliseZone.y + baliseZone.height / 2;
                mmx = centerX * zoomScale + offsetX;
                mmy = centerY * zoomScale + offsetY;
            }

            let cadreSize, roseSize, traicapSize;
            if (isMobile) {
                cadreSize = min(width, height) * 0.4;
                roseSize = min(width, height) * 0.35;
                traicapSize = min(width, height) * 0.4;
            } else {
                cadreSize = 368;
                roseSize = 368;
                traicapSize = 368;
            }

            drawMainElements(NDX, NDY, cadreSize, roseSize, traicapSize, NDBX1, NDBY1, NDBX2, NDBY2);
            calculateNavigation(NDX, NDY, NDBX1, NDBY1, NDBX2, NDBY2);
            drawAircraft(NDX);
            drawBaliseNumbers(NDBX1, NDBY1, NDBX2, NDBY2);

            pop();
            updateAnswers();
        }

        function drawBaliseNumbers(NDBX1, NDBY1, NDBX2, NDBY2) {
            // Num√©ros en ROUGE sur les balises
            fill(255, 0, 0); // Rouge
            textSize(isMobile ? 16 : 20);
            textAlign(CENTER, CENTER);
            textStyle(BOLD);
            text("1", NDBX1, NDBY1);
            text("2", NDBX2, NDBY2);
            textAlign(LEFT, CENTER);
            textStyle(NORMAL);
        }

        function calculateBaliseZone(NDBX1, NDBY1, NDBX2, NDBY2) {
            const minX = min(NDBX1, NDBX2) - baliseZone.padding;
            const maxX = max(NDBX1, NDBX2) + baliseZone.padding;
            const minY = min(NDBY1, NDBY2) - baliseZone.padding;
            const maxY = max(NDBY1, NDBY2) + baliseZone.padding;
            
            baliseZone.x = minX;
            baliseZone.y = minY;
            baliseZone.width = maxX - minX;
            baliseZone.height = maxY - minY;
        }

        function drawBaliseZone() {
            stroke(0, 100, 255, 150);
            strokeWeight(3);
            noFill();
            rect(baliseZone.x + baliseZone.width/2, baliseZone.y + baliseZone.height/2, 
                 baliseZone.width, baliseZone.height);
            noStroke();
            
            fill(0, 100, 255);
            textSize(isMobile ? 10 : 12);
            textAlign(CENTER);
            text("Zone de d√©placement de l'avion", 
                 baliseZone.x + baliseZone.width/2, 
                 baliseZone.y - 15);
            textAlign(LEFT);
        }

        function isInBaliseZone(x, y) {
            return x >= baliseZone.x && 
                   x <= baliseZone.x + baliseZone.width && 
                   y >= baliseZone.y && 
                   y <= baliseZone.y + baliseZone.height;
        }

        function updateCapContinuous() {
            let currentTime = millis();
            if (currentTime - lastUpdateTime > CAP_CHANGE_INTERVAL) {
                if (!isMobile && rightMousePressed) {
                    rose = (rose + 1) % 360;
                }
                if (isMobile) {
                    if (capPlusPressed) rose = (rose + 2) % 360;
                    if (capMoinsPressed) rose = (rose - 2 + 360) % 360;
                }
                lastUpdateTime = currentTime;
            }
        }

        function updateAircraftPosition() {
            if (!isMobile && leftMousePressed) {
                let targetX = mouseX;
                let targetY = mouseY;
                
                let adjustedTargetX = (targetX - offsetX) / zoomScale;
                let adjustedTargetY = (targetY - offsetY) / zoomScale;
                
                if (isInBaliseZone(adjustedTargetX, adjustedTargetY)) {
                    mmx = targetX;
                    mmy = targetY;
                }
            }
        }

        function drawMainElements(NDX, NDY, cadreSize, roseSize, traicapSize, NDBX1, NDBY1, NDBX2, NDBY2) {
            if (imagesLoaded) {
                try {
                    image(imgNDcadre, NDX, NDY, cadreSize, cadreSize);
                    image(imgNDmaquette, NDX, NDY, cadreSize/10, cadreSize/10);

                    push();
                    translate(NDX, NDY);
                    rotate(radians(-rose));
                    image(imgNDrose, 0, 0, roseSize, roseSize); 
                    pop();
                   
                    image(imgtraicap, NDX, NDY, cadreSize, cadreSize); 
                    
                    push();
                    translate(NDX, NDY);
                    rotate(radians(QDM));  
                    image(flecheNDDouble, 0, 0, roseSize, roseSize);
                    pop();

                    push();
                    translate(NDX, NDY);
                    rotate(radians(QDM1));  
                    image(flecheNDSimple, 0, 0, roseSize, roseSize);
                    pop();

                    image(imgNDB, NDBX1, NDBY1);
                    image(imgNDB, NDBX2, NDBY2);
                    
                } catch (e) {
                    console.log("Erreur lors du dessin des images:", e);
                    drawFallbackGraphics(NDX, NDY, cadreSize, roseSize, NDBX1, NDBY1, NDBX2, NDBY2);
                }
            } else {
                drawFallbackGraphics(NDX, NDY, cadreSize, roseSize, NDBX1, NDBY1, NDBX2, NDBY2);
            }
        }

        function drawFallbackGraphics(NDX, NDY, cadreSize, roseSize, NDBX1, NDBY1, NDBX2, NDBY2) {
            // Cadre principal
            stroke(0);
            strokeWeight(2);
            noFill();
            rect(NDX, NDY, cadreSize, cadreSize);
            
            // Rose des vents
            stroke(100);
            strokeWeight(1);
            noFill();
            circle(NDX, NDY, roseSize);
            
            // Indicateur de cap
            fill(100);
            noStroke();
            rect(NDX-15, NDY, 30, 10);
            
            // Balises
            fill(255, 0, 0);
            circle(NDBX1, NDBY1, 20);
            circle(NDBX2, NDBY2, 20);
            
            // Fl√®ches
            stroke(255, 0, 0);
            strokeWeight(3);
            push();
            translate(NDX, NDY);
            rotate(radians(QDM));
            line(0, 0, 0, -100);
            pop();
            
            stroke(0, 0, 255);
            push();
            translate(NDX, NDY);
            rotate(radians(QDM1));
            line(0, 0, 0, -120);
            pop();
        }

        function calculateNavigation(NDX, NDY, NDBX1, NDBY1, NDBX2, NDBY2) {
            let adjustedMmx = (mmx - offsetX) / zoomScale;
            let adjustedMmy = (mmy - offsetY) / zoomScale;

            mx1 = adjustedMmx - NDBX1;
            my1 = adjustedMmy - NDBY1;
            avion = createVector(mx1, my1);
            
            let angle1 = atan2(my1, mx1);
            QDR1 = degrees(angle1);
            if (QDR1 < 0) QDR1 += 360;
            
            QDM1 = (QDR1 + 180) % 360;
            GT = (QDM1 - rose + 360) % 360;

            mx2 = adjustedMmx - NDBX2;
            my2 = adjustedMmy - NDBY2;
            avion1 = createVector(mx2, my2);
            
            let angle2 = atan2(my2, mx2);
            QDR3 = degrees(angle2);
            if (QDR3 < 0) QDR3 += 360;
            
            QDM = (QDR3 + 180) % 360;
            GT1 = (QDM - rose + 360) % 360;
        }

        function drawAircraft(NDX) {
            let adjustedMmx = (mmx - offsetX) / zoomScale;
            let adjustedMmy = (mmy - offsetY) / zoomScale;

            push();
            translate(adjustedMmx, adjustedMmy);
            rotate(radians(rose));
            if (imagesLoaded) {
                try {
                    image(imgPlane, 1, 5);
                } catch (e) {
                    drawFallbackAircraft();
                }
            } else {
                drawFallbackAircraft();
            }
            pop();
        }

        function drawFallbackAircraft() {
            fill(255, 0, 0);
            triangle(-15, -10, 15, -10, 0, -25);
            rect(-5, 0, 10, 15);
        }

        function updateAnswers() {
            const reponsesBox = document.getElementById('reponsesBox');
            if (reponsesBox) {
                let txt = "";
                if (reponse) {
                    txt += "QDR1 = " + Math.round(QDR1) + "¬∞<br>";
                    txt += "QDM1 = " + Math.round(QDM1) + "¬∞<br>";
                    txt += "GT1 = " + Math.round(GT) + "¬∞<br>";
                    txt += "CAP = " + Math.round(rose) + "¬∞<br>";
                    txt += "QDR2 = " + Math.round(QDR3) + "¬∞<br>";
                    txt += "QDM2 = " + Math.round(QDM) + "¬∞<br>";
                    txt += "GT2 = " + Math.round(GT1) + "¬∞";
                } else {
                    txt += "QDR1 = ?<br>QDM1 = ?<br>GT1 = ?<br>CAP = ?<br>QDR2 = ?<br>QDM2 = ?<br>GT2 = ?";
                }
                reponsesBox.innerHTML = txt;
            }
        }

        function mousePressed() {
            if (!isMobile) {
                if (mouseButton === RIGHT) {
                    rightMousePressed = true;
                    lastUpdateTime = millis();
                    return false;
                } else if (mouseButton === LEFT) {
                    let adjustedMouseX = (mouseX - offsetX) / zoomScale;
                    let adjustedMouseY = (mouseY - offsetY) / zoomScale;
                    
                    if (isInBaliseZone(adjustedMouseX, adjustedMouseY)) {
                        leftMousePressed = true;
                    }
                    return false;
                }
            }
            return false;
        }

        function mouseReleased() {
            if (!isMobile) {
                if (mouseButton === RIGHT) {
                    rightMousePressed = false;
                    return false;
                } else if (mouseButton === LEFT) {
                    leftMousePressed = false;
                    return false;
                }
            }
            return false;
        }

        function keyPressed() {
            if (key === '3') {
                randomBoth();
            }
        }

        function touchStarted(event) {
            if (isMobile) {
                const touchX = event.touches[0].clientX;
                const touchY = event.touches[0].clientY;
                
                let adjustedTouchX = (touchX - offsetX) / zoomScale;
                let adjustedTouchY = (touchY - offsetY) / zoomScale;
                
                if (isInBaliseZone(adjustedTouchX, adjustedTouchY)) {
                    aircraftMoving = true;
                    mmx = touchX;
                    mmy = touchY;
                    
                    if (touches.length === 1) {
                        isDragging = true;
                        lastTouchX = touchX;
                        lastTouchY = touchY;
                    } else if (touches.length === 2) {
                        lastTouchDistance = dist(
                            touches[0].x, touches[0].y,
                            touches[1].x, touches[1].y
                        );
                    }
                    // Emp√™cher le d√©filement seulement si on d√©place l'avion
                    event.preventDefault();
                }
                // Permettre le d√©filement si on ne touche pas la zone de l'avion
                return false;
            }
            return false;
        }

        function touchMoved(event) {
            if (isMobile && aircraftMoving) {
                if (touches.length === 1 && isDragging) {
                    let targetX = touches[0].x;
                    let targetY = touches[0].y;
                    
                    let adjustedTargetX = (targetX - offsetX) / zoomScale;
                    let adjustedTargetY = (targetY - offsetY) / zoomScale;
                    
                    if (isInBaliseZone(adjustedTargetX, adjustedTargetY)) {
                        mmx = targetX;
                        mmy = targetY;
                    }
                    // Emp√™cher le d√©filement seulement si on d√©place l'avion
                    event.preventDefault();
                } else if (touches.length === 2) {
                    let currentDistance = dist(
                        touches[0].x, touches[0].y,
                        touches[1].x, touches[1].y
                    );
                    
                    let zoomFactor = currentDistance / lastTouchDistance;
                    zoomScale *= zoomFactor;
                    zoomScale = constrain(zoomScale, 0.5, 3.0);
                    
                    lastTouchDistance = currentDistance;
                    event.preventDefault();
                }
            }
            // Permettre le d√©filement si on ne d√©place pas l'avion
            return false;
        }

        function touchEnded() {
            if (isMobile) {
                aircraftMoving = false;
                if (touches.length === 0) {
                    isDragging = false;
                }
            }
            return false;
        }

        function windowResized() {
            if (isMobile) {
                resizeCanvas(windowWidth * 0.95, 400); // Hauteur fixe pour mobile
            } else {
                resizeCanvas(1000, 500);
            }
        }

        function randomPosition() {
            let centerX = baliseZone.x + baliseZone.width / 2;
            let centerY = baliseZone.y + baliseZone.height / 2;
            
            let randomX = random(baliseZone.x, baliseZone.x + baliseZone.width);
            let randomY = random(baliseZone.y, baliseZone.y + baliseZone.height);
            
            mmx = randomX * zoomScale + offsetX;
            mmy = randomY * zoomScale + offsetY;
        }

        function randomCap() {
            rose = random(0, 359);
        }

        function randomBoth() {
            randomPosition();
            randomCap();
        }

        function toggleReponse() {
            reponse = !reponse;
            updateAnswers();
        }

        // Emp√™cher le menu contextuel uniquement sur le canvas
        document.addEventListener('contextmenu', function(e) {
            if (e.target.tagName === 'CANVAS') {
                e.preventDefault();
                return false;
            }
        });
    </script>
</body>
</html>
