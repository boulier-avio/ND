<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADF sur ND</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        
        #landscapeWarning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.9);
            color: white;
            z-index: 10000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .consigne {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            text-align: left;
        }
        
        .astuce {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-style: italic;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        button {
            padding: 12px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            min-width: 140px;
        }
        
        .cap-controls {
            display: flex;
            gap: 5px;
        }
        
        .cap-btn {
            width: 50px;
            height: 50px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 20px;
            font-weight: bold;
        }
        
        #canvasContainer {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            background: white;
            position: relative;
            overflow: hidden;
        }
        
        #reponsesBox {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            padding: 15px;
            font-size: 1.05em;
            color: #d63c3c;
            text-align: center;
        }
        
        .mobile-only {
            display: none;
        }
        
        @media (max-width: 768px) {
            .mobile-only {
                display: flex;
            }
            
            #canvasContainer {
                height: 300px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
        }
        
        @media (max-width: 768px) and (orientation: landscape) {
            .container {
                display: none;
            }
            #landscapeWarning {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div id="landscapeWarning">
        <h2>â¤¸ Veuillez tourner votre appareil</h2>
        <p>Cette application est optimisÃ©e pour le mode portrait.</p>
    </div>

    <div class="container">
        <h1>Navigation ADF sur ND</h1>
        
        <div class="consigne">
            <h3>ðŸ“‹ Consigne :</h3>
            <p><strong>DÃ©termine la position de l'avion, son cap, le gisement ainsi que les relÃ¨vements QDR et QDM Ã  partir de l'instrument.</strong></p>
            <p>DÃ©placez l'avion librement sur l'Ã©cran et modifiez son cap pour observer les changements dans les mesures.</p>
            
            <div class="astuce">
                <strong>Astuce :</strong><br>
                â€¢ Sur mobile : touchez l'Ã©cran pour dÃ©placer l'avion<br>
                â€¢ Utilisez les boutons + et - pour modifier le cap<br>
                â€¢ La flÃ¨che double indique le QDM vers la balise de droite (NDB 2)<br>
                â€¢ La flÃ¨che simple indique le QDM vers la balise de gauche (NDB 1)
            </div>
        </div>

        <div class="controls">
            <div class="cap-controls mobile-only">
                <button class="cap-btn" id="capMoins">-</button>
                <button class="cap-btn" id="capPlus">+</button>
            </div>
            <button id="randomBothBtn">Position/Cap AlÃ©atoire (3)</button>
            <button id="toggleReponseBtn">Afficher/Masquer RÃ©ponse</button>
        </div>
        
        <div id="canvasContainer">
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#666;">
                Chargement des images...
            </div>
        </div>
        
        <div id="reponsesBox">
            QDR1 = ?<br>QDM1 = ?<br>GT1 = ?<br>CAP = ?<br>QDR2 = ?<br>QDM2 = ?<br>GT2 = ?
        </div>
    </div>
    
    <script>
        let imgNDcadre, imgNDmaquette, imgNDrose, imgtraicap;
        let flecheNDDouble, flecheNDSimple, imgNDB, imgPlane;
        let rose = 0;
        let QDR1, QDR3, QDM, QDM1, GT, GT1;
        let mx1, mx2, my1, my2, mmx, mmy;
        let reponse = false;
        let isMobile = false;
        let imagesLoaded = false;

        // Variables pour le contrÃ´le mobile
        let capPlusPressed = false;
        let capMoinsPressed = false;

        let canvas;

        function preload() {
            imgNDcadre = loadImage('NDcadre.png', () => {}, () => {});
            imgNDmaquette = loadImage('NDmaquette.png', () => {}, () => {});
            imgNDrose = loadImage('NDrose.png', () => {}, () => {});
            flecheNDDouble = loadImage('NDDouble.png', () => {}, () => {});
            flecheNDSimple = loadImage('NDSimple.png', () => {}, () => {});
            imgNDB = loadImage('NDB.png', () => {}, () => {});
            imgPlane = loadImage('plane.png', () => {}, () => {});
            imgtraicap = loadImage('traicap.png', () => {}, () => {});
            
            setTimeout(() => {
                imagesLoaded = true;
                document.querySelector('#canvasContainer div').style.display = 'none';
            }, 1000);
        }

        function setup() {
            isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            const container = document.getElementById('canvasContainer');
            const rect = container.getBoundingClientRect();
            
            canvas = createCanvas(rect.width, rect.height);
            canvas.parent('canvasContainer');
            
            // Configuration pour le tactile
            canvas.elt.style.touchAction = 'none';
            
            imageMode(CENTER);
            rectMode(CENTER);
            textAlign(CENTER, CENTER);
            
            setupButtonEvents();
            
            // Position initiale de l'avion au centre
            mmx = width / 2;
            mmy = height / 2;
        }

        function setupButtonEvents() {
            document.getElementById('capPlus').addEventListener('click', () => {
                rose = (rose + 5) % 360;
            });
            
            document.getElementById('capMoins').addEventListener('click', () => {
                rose = (rose - 5 + 360) % 360;
            });
            
            document.getElementById('randomBothBtn').addEventListener('click', randomBoth);
            document.getElementById('toggleReponseBtn').addEventListener('click', toggleReponse);
        }

        function draw() {
            background(255);
            
            // Mise Ã  jour continue du cap si les boutons sont pressÃ©s
            if (capPlusPressed) rose = (rose + 2) % 360;
            if (capMoinsPressed) rose = (rose - 2 + 360) % 360;

            let NDX = width * 0.35;
            let NDY = height * 0.4;
            let NDBX1 = width * 0.75;
            let NDBY1 = height * 0.3;
            let NDBX2 = width * 0.75;
            let NDBY2 = height * 0.6;

            let cadreSize = min(width, height) * 0.35;
            let roseSize = min(width, height) * 0.3;

            drawMainElements(NDX, NDY, cadreSize, roseSize, NDBX1, NDBY1, NDBX2, NDBY2);
            calculateNavigation(NDX, NDY, NDBX1, NDBY1, NDBX2, NDBY2);
            drawAircraft();
            drawBaliseNumbers(NDBX1, NDBY1, NDBX2, NDBY2);

            updateAnswers();
        }

        function drawBaliseNumbers(NDBX1, NDBY1, NDBX2, NDBY2) {
            fill(255, 0, 0);
            textSize(14);
            textStyle(BOLD);
            text("1", NDBX1, NDBY1);
            text("2", NDBX2, NDBY2);
        }

        function drawMainElements(NDX, NDY, cadreSize, roseSize, NDBX1, NDBY1, NDBX2, NDBY2) {
            if (imagesLoaded) {
                try {
                    image(imgNDcadre, NDX, NDY, cadreSize, cadreSize);
                    
                    push();
                    translate(NDX, NDY);
                    rotate(radians(-rose));
                    image(imgNDrose, 0, 0, roseSize, roseSize); 
                    pop();
                   
                    image(imgtraicap, NDX, NDY, cadreSize, cadreSize); 
                    
                    push();
                    translate(NDX, NDY);
                    rotate(radians(QDM));  
                    image(flecheNDDouble, 0, 0, roseSize, roseSize);
                    pop();

                    push();
                    translate(NDX, NDY);
                    rotate(radians(QDM1));  
                    image(flecheNDSimple, 0, 0, roseSize, roseSize);
                    pop();

                    image(imgNDB, NDBX1, NDBY1);
                    image(imgNDB, NDBX2, NDBY2);
                    
                } catch (e) {
                    drawFallbackGraphics(NDX, NDY, cadreSize, roseSize, NDBX1, NDBY1, NDBX2, NDBY2);
                }
            } else {
                drawFallbackGraphics(NDX, NDY, cadreSize, roseSize, NDBX1, NDBY1, NDBX2, NDBY2);
            }
        }

        function drawFallbackGraphics(NDX, NDY, cadreSize, roseSize, NDBX1, NDBY1, NDBX2, NDBY2) {
            stroke(0);
            strokeWeight(2);
            noFill();
            rect(NDX, NDY, cadreSize, cadreSize);
            
            stroke(100);
            circle(NDX, NDY, roseSize);
            
            fill(255, 0, 0);
            circle(NDBX1, NDBY1, 20);
            circle(NDBX2, NDBY2, 20);
        }

        function calculateNavigation(NDX, NDY, NDBX1, NDBY1, NDBX2, NDBY2) {
            mx1 = mmx - NDBX1;
            my1 = mmy - NDBY1;
            
            let angle1 = atan2(my1, mx1);
            QDR1 = degrees(angle1);
            if (QDR1 < 0) QDR1 += 360;
            
            QDM1 = (QDR1 + 180) % 360;
            GT = (QDM1 - rose + 360) % 360;

            mx2 = mmx - NDBX2;
            my2 = mmy - NDBY2;
            
            let angle2 = atan2(my2, mx2);
            QDR3 = degrees(angle2);
            if (QDR3 < 0) QDR3 += 360;
            
            QDM = (QDR3 + 180) % 360;
            GT1 = (QDM - rose + 360) % 360;
        }

        function drawAircraft() {
            push();
            translate(mmx, mmy);
            rotate(radians(rose));
            if (imagesLoaded) {
                try {
                    image(imgPlane, 0, 0, 30, 30);
                } catch (e) {
                    drawFallbackAircraft();
                }
            } else {
                drawFallbackAircraft();
            }
            pop();
        }

        function drawFallbackAircraft() {
            fill(0, 0, 255);
            triangle(-10, -8, 10, -8, 0, -15);
            rect(-4, 0, 8, 12);
        }

        function updateAnswers() {
            const reponsesBox = document.getElementById('reponsesBox');
            if (reponse) {
                reponsesBox.innerHTML = 
                    "QDR1 = " + Math.round(QDR1) + "Â°<br>" +
                    "QDM1 = " + Math.round(QDM1) + "Â°<br>" +
                    "GT1 = " + Math.round(GT) + "Â°<br>" +
                    "CAP = " + Math.round(rose) + "Â°<br>" +
                    "QDR2 = " + Math.round(QDR3) + "Â°<br>" +
                    "QDM2 = " + Math.round(QDM) + "Â°<br>" +
                    "GT2 = " + Math.round(GT1) + "Â°";
            } else {
                reponsesBox.innerHTML = "QDR1 = ?<br>QDM1 = ?<br>GT1 = ?<br>CAP = ?<br>QDR2 = ?<br>QDM2 = ?<br>GT2 = ?";
            }
        }

        // GESTION DU TACTILE - SIMPLIFIÃ‰E
        function touchStarted() {
            // DÃ©placer l'avion Ã  la position du toucher
            mmx = mouseX;
            mmy = mouseY;
            return false;
        }

        function touchMoved() {
            // DÃ©placer l'avion en suivant le doigt
            mmx = mouseX;
            mmy = mouseY;
            return false;
        }

        function mousePressed() {
            if (isMobile) {
                mmx = mouseX;
                mmy = mouseY;
                return false;
            }
        }

        function mouseDragged() {
            if (isMobile) {
                mmx = mouseX;
                mmy = mouseY;
                return false;
            }
        }

        function keyPressed() {
            if (key === '3') {
                randomBoth();
            }
        }

        function windowResized() {
            const container = document.getElementById('canvasContainer');
            const rect = container.getBoundingClientRect();
            resizeCanvas(rect.width, rect.height);
        }

        function randomPosition() {
            mmx = random(50, width - 50);
            mmy = random(50, height - 50);
        }

        function randomCap() {
            rose = random(0, 359);
        }

        function randomBoth() {
            randomPosition();
            randomCap();
        }

        function toggleReponse() {
            reponse = !reponse;
        }

        // Gestion des boutons tactiles pour le cap
        document.getElementById('capPlus').addEventListener('touchstart', (e) => {
            e.preventDefault();
            capPlusPressed = true;
        });

        document.getElementById('capPlus').addEventListener('touchend', (e) => {
            e.preventDefault();
            capPlusPressed = false;
        });

        document.getElementById('capMoins').addEventListener('touchstart', (e) => {
            e.preventDefault();
            capMoinsPressed = true;
        });

        document.getElementById('capMoins').addEventListener('touchend', (e) => {
            e.preventDefault();
            capMoinsPressed = false;
        });
    </script>
</body>
</html>
