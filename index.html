<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOULIER gisement ADF sur ND</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .mobile-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        .control-btn {
            width: 60px;
            height: 60px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            margin: 5px;
            touch-action: manipulation;
        }
    </style>
</head>
<body>
    <div class="mobile-controls">
        <button class="control-btn" id="capPlus">+</button>
        <button class="control-btn" id="capMoins">-</button>
    </div>

    <script>
        let imgNDcadre, imgNDmaquette, imgNDrose, imgADF1, imgADF3;
        let flecheNDDouble, flecheNDSimple, imgNDB, imgPlane;
        let rose = 0;
        let QDR1, QDR3, QDM, QDM1, GT, GT1;
        let mx1, mx2, my1, my2, mmx, mmy;
        let rot;
        let reponse = false;
        let baliseLH, baliseRH, avion, avion1;
        let isMobile = false;

        function preload() {
            imgNDcadre = loadImage('NDcadre.png');
            imgNDmaquette = loadImage('NDmaquette.png');
            imgNDrose = loadImage('NDrose.png');
            imgADF1 = loadImage('ADF1.png');
            imgADF3 = loadImage('ADF3.png');
            flecheNDDouble = loadImage('NDDouble.png');
            flecheNDSimple = loadImage('NDSimple.png');
            imgNDB = loadImage('NDB.png');
            imgPlane = loadImage('plane.png');
        }

        function setup() {
            // Détection mobile
            isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            createCanvas(windowWidth, windowHeight);
            mmx = width / 2;
            mmy = height / 2;
            baliseLH = createVector(0, -10);
            baliseRH = createVector(0, -10);
            imageMode(CENTER);
            rectMode(CENTER);
            
            // Configuration des boutons mobiles
            if (isMobile) {
                document.getElementById('capPlus').addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    rose = (rose + 1) % 360;
                });
                
                document.getElementById('capMoins').addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    rose = (rose - 1 + 360) % 360;
                });
            }
        }

        function draw() {
            background(255);
            
            // Ajustement des positions pour mobile
            let NDX, NDY, NDBX1, NDBY1, NDBX2, NDBY2;
            
            if (isMobile) {
                // Positions adaptées pour mobile
                NDX = width * 0.2;
                NDY = height * 0.3;
                NDBX1 = width * 0.6;
                NDBY1 = height * 0.3;
                NDBX2 = width * 0.8;
                NDBY2 = height * 0.6;
            } else {
                // Positions originales pour desktop
                NDX = 183;
                NDY = 183;
                NDBX1 = 553;
                NDBY1 = 183;
                NDBX2 = 753;
                NDBY2 = 383;
            }

            // Mettre à jour la position de l'avion avec le touch/la souris
            if ((isMobile && touches.length > 0) || (!isMobile && mouseX > NDX + 200)) {
                if (isMobile) {
                    mmx = touches[0].x;
                    mmy = touches[0].y;
                } else {
                    mmx = mouseX;
                    mmy = mouseY;
                }
            }

            // Ajustement de la taille des images pour mobile
            let cadreSize = isMobile ? min(width, height) * 0.4 : 368;
            let roseSize = isMobile ? min(width, height) * 0.3 : 271;
            
            image(imgNDcadre, NDX, NDY, cadreSize, cadreSize);
            image(imgNDmaquette, NDX, NDY+18, 31, 27);
            image(imgADF1, 60, 311, 51, 28);
            image(imgADF3, 300, 311, 54, 34);

            push();
            translate(NDX, NDY+14);  
            rotate(radians(-rose));
            image(imgNDrose, 0, 0, roseSize, roseSize); 
            pop();
            
            push();
            translate(NDX, NDY+15);
            rotate(radians(QDM));  
            image(flecheNDDouble, 0, 0, 17, 231);
            pop();

            push();
            translate(NDX, NDY+15);
            rotate(radians(QDM1));  
            image(flecheNDSimple, 0, 0, 20, 231);
            pop();

            image(imgNDB, NDBX1, NDBY1);
            image(imgNDB, NDBX2, NDBY2);

            stroke(233, 255, 3);
            strokeWeight(2);
            line(NDX, 71, NDX, 88);
            noStroke();

            // Calculs de navigation
            mx1 = mmx - NDBX1;
            my1 = mmy - NDBY1;
            avion = createVector(mx1, my1);
            QDR = p5.Vector.angleBetween(baliseLH, avion);
            
            if (mmx < NDBX1) {
                QDR1 = map(QDR, PI, 0, 181, 360);
            } else {
                QDR1 = degrees(QDR);
            }

            if (QDR1 < 180) rot = 180;
            else rot = -180;
            
            QDM1 = QDR1 + rot;
            GT = QDM1 - rose;
            if (GT < 0) GT += 360;

            mx2 = mmx - NDBX2;
            my2 = mmy - NDBY2;
            avion1 = createVector(mx2, my2);
            QDR2 = p5.Vector.angleBetween(baliseRH, avion1);
            
            if (mmx < NDBX2) {
                QDR3 = map(QDR2, PI, 0, 181, 360);
            } else {
                QDR3 = degrees(QDR2);
            }

            if (QDR3 < 180) rot = 180;
            else rot = -180;
            
            QDM = QDR3 + rot;
            GT1 = QDM - rose;
            if (GT1 < 0) GT1 += 360;

            // Afficher l'avion
            if ((isMobile && touches.length > 0) || (!isMobile && mouseX > NDX + 200)) {
                if (!isMobile) noCursor();
                push();
                translate(mmx, mmy);
                rotate(radians(rose));
                image(imgPlane, 1, 5);
                pop();
            } else {
                if (!isMobile) cursor(ARROW);
            }

            // Interface adaptée pour mobile
            let textY = isMobile ? height * 0.7 : 400;
            let textStep = isMobile ? 15 : 15;
            
            fill(0);
            rect(50, textY + 150, 90, 25);
            fill(255);
            text("infos", 50, textY + 150);

            fill(0);
            textSize(isMobile ? 10 : 12);
            if (reponse) {
                text(round(QDR1), 55, textY);
                text(round(QDM1), 55, textY + textStep);
                text(round(GT), 55, textY + textStep * 2);
                text(round(rose), 55, textY + textStep * 3);
                text(round(QDR3), 55, textY + textStep * 4);
                text(round(QDM), 55, textY + textStep * 5);
                text(round(GT1), 55, textY + textStep * 6);
            }

            text("QDR1 =", 5, textY);
            text("QDM1 =", 5, textY + textStep);
            text(" GT1 =", 5, textY + textStep * 2);
            text(" CAP =", 5, textY + textStep * 3);
            text("QDR2 =", 5, textY + textStep * 4);
            text("QDM2 =", 5, textY + textStep * 5);
            text(" GT2 =", 5, textY + textStep * 6);

            if (!isMobile && mouseX > 5 && mouseX < 95 && mouseY > textY + 120 && mouseY < textY + 145) {
                fill(255, 0, 0);
                text("Clic droit: changer cap", 6, textY + 160);
                text("Touche 1: afficher/cacher réponses", 6, textY + 175);
            }
            
            if (isMobile) {
                fill(0);
                textSize(12);
                text("Toucher l'écran pour déplacer l'avion", width/2, 50);
            }
        }

        function mousePressed() {
            if (!isMobile && mouseButton === RIGHT) {
                rose++;
                return false;
            }
            return false;
        }

        function keyPressed() {
            if (key === '1') {
                reponse = !reponse;
            }
        }

        function touchStarted() {
            if (isMobile) {
                return false; // Empêche le défilement
            }
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }

        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
    </script>
</body>
</html>
