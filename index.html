<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>ADF sur ND1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.js"></script>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-text-size-adjust: none;
        }
        /* Message pour le mode paysage */
        #landscapeWarning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.9);
            color: white;
            z-index: 10000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        #landscapeWarning h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        #landscapeWarning p {
            font-size: 1.1em;
            line-height: 1.4;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
            max-width: 100vw;
            box-sizing: border-box;
            padding: 10px;
        }
        .instructions {
            background-color: white;
            padding: 12px 0;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 100vw;
            max-width: 100vw;
            box-sizing: border-box;
            text-align: center;
            margin: 0;
        }
        .consigne {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            width: 100vw;
            max-width: 100vw;
        }
        .consigne h3 {
            color: #856404;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .consigne p {
            margin: 5px 0;
            font-size: 0.95em;
            line-height: 1.4;
        }
        .astuce {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-style: italic;
            font-size: 0.9em;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            margin: 0;
        }
        button {
            padding: 12px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            flex: 1;
            min-width: 140px;
            max-width: 200px;
            touch-action: manipulation;
        }
        button:hover, button:active {
            background-color: #45a049;
        }
        .cap-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .cap-btn {
            width: 50px;
            height: 50px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
        }
        .cap-btn:hover {
            background-color: #1976D2;
        }
        .jeu-reponse-row {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100vw;
            max-width: 100vw;
            box-sizing: border-box;
            gap: 15px;
            margin: 0 auto;
        }
        #canvasContainer {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            max-width: 100wv;
            position: relative;
            height: 50vh;
            min-height: 300px;
            border: 1px solid #ccc;
            background: white;
            overflow: hidden;
        }
        #canvasContainer canvas {
            pointer-events: auto;
            width: 100% !important;
            height: 100% !important;
        }
        #reponsesBox {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            padding: 15px;
            width: 100%;
            max-width: 100%;
            font-size: 1.05em;
            color: #d63c3c;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-sizing: border-box;
        }
        /* Masquer les boutons cap sur ordinateur */
        @media (min-width: 901px) {
            .mobile-only {
                display: none !important;
            }
            #canvasContainer {
                height: 500px;
                max-width: 1000px;
            }
        }
        @media (max-width: 900px) {
            .mobile-only {
                display: flex;
            }
           
            .consigne {
                padding: 12px;
                margin: 8px 0;
            }
            #canvasContainer {
                height: 50vh;
                min-height: 350px;
            }
            .controls {
                flex-direction: column;
                align-items: center;
            }
            button {
                max-width: 100%;
                width: 100%;
            }
            .cap-controls {
                justify-content: center;
                width: 100%;
            }
        }
        /* Adaptation pour mobile en mode portrait */
        @media (max-width: 768px) and (orientation: portrait) {
            .container {
                gap: 10px;
                padding: 5px;
            }
            .consigne {
                padding: 10px;
                margin: 5px 0;
            }
            #canvasContainer {
                height: 50vh;
                min-height: 300px;
            }
            .jeu-reponse-row {
                gap: 10px;
            }
            .controls {
                gap: 8px;
            }
            button {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
        }
        /* Cacher l'application en mode paysage */
        @media (max-width: 768px) and (orientation: landscape) {
            .container {
                display: none;
            }
            #landscapeWarning {
                display: flex;
            }
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: rgba(30,30,30,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal > div {
            background: #fff;
            padding: 24px 20px;
            border-radius: 12px;
            max-width: 350px;
            margin: 50px auto;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            text-align: left;
            position: relative;
        }
        .closeBtn {
            position: absolute; 
            top: 5px; 
            right: 7px; 
            background: transparent; 
            border: none; 
            font-size: 1.6em; 
            cursor: pointer;
        }
        .helpBtn {
            background: #eee; 
            color: #333;
            border: 1px solid #ccc; 
            border-radius: 5px; 
            font-size: 1rem; 
            padding: 4px 12px; 
            cursor: pointer;
            margin-bottom: 8px;
        }
        .help-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .contact-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 12px;
            color: #666;
            z-index: 100;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .contact-info a {
            color: #0066cc;
            text-decoration: none;
        }
        .contact-info a:hover {
            text-decoration: underline;
        }
        .hidden {
            display: none !important;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Message d'avertissement pour le mode paysage -->
    <div id="landscapeWarning">
        <h2>‚§∏ Veuillez tourner votre appareil</h2>
        <p>Cette application est optimis√©e pour le mode portrait.<br>Veuillez retourner votre t√©l√©phone en mode vertical.</p>
    </div>

    <div class="container">
        <h1>Navigation ADF sur ND</h1>
        
        <div class="consigne">
            <h3>üìã Consigne :</h3>
            <p><strong>D√©termine la position de l'avion, son cap, le gisement ainsi que les rel√®vements QDR et QDM √† partir de l'instrument.</strong></p>
            <p>D√©placez l'avion librement sur l'√©cran et modifiez son cap pour observer les changements dans les mesures.</p>
            
            <div class="astuce">
                <strong>Astuce :</strong><br>
                ‚Ä¢ Sur ordinateur : clic gauche pour d√©placer l'avion, clic droit pour modifier le cap<br>
                ‚Ä¢ Sur mobile : utilisez les boutons + et - pour modifier le cap, et le pincement pour zoomer<br>
                ‚Ä¢ La fl√®che double indique le QDM vers la balise de droite (NDB 2)<br>
                ‚Ä¢ La fl√®che simple indique le QDM vers la balise de gauche (NDB 1)
            </div>
        </div>

        <div class="controls">
            <!-- Boutons cap seulement sur mobile -->
            <div class="cap-controls mobile-only">
                <button class="cap-btn" id="capMoins">Cap -</button>
                <button class="cap-btn" id="capPlus">Cap +</button>
            </div>
            <button id="randomBothBtn">Position/Cap Al√©atoire (3)</button>
            <button id="toggleReponseBtn">Afficher/Masquer R√©ponse</button>
        </div>
        
        <div class="jeu-reponse-row">
            <div id="canvasContainer">
            
            </div>
            <div id="reponsesBox">QDR1 = ?<br>QDM1 = ?<br>GT1 = ?<br>CAP = ?<br>QDR2 = ?<br>QDM2 = ?<br>GT2 = ?</div>
        </div>
        
        <div class="help-buttons">
            <button id="showTermsBtn" class="helpBtn">‚ùì Explication des termes</button>
            <button id="showButtonsBtn" class="helpBtn">üîÑ Explication des boutons</button>
        </div>
        
        <div id="termsModal" class="modal">
            <div>
                <button class="closeBtn">&times;</button>
                <h2>Que signifient GT, QDM, QDR et Cap ?</h2>
                <ul>
                    <li><strong>GT :</strong> Gisement transmis par l'ADF, angle entre le nez de l'avion et la direction de la balise.</li>
                    <li><strong>QDM :</strong> Cap magn√©tique √† suivre pour aller vers la balise depuis la position de l'avion.</li>
                    <li><strong>QDR :</strong> Rel√®vement magn√©tique de la balise, cap √† suivre pour s'√©loigner de la balise.</li>
                    <li><strong>Cap :</strong> Direction du nez de l'avion par rapport au nord magn√©tique.</li>
                </ul>
            </div>
        </div>
        
        <div id="buttonsModal" class="modal">
            <div>
                <button class="closeBtn">&times;</button>
                <h2>√Ä quoi servent les boutons ?</h2>
                <ul>
                    <li><strong>Boutons + et - (mobile uniquement):</strong> Modifient le cap de l'avion</li>
                    <li><strong>Position/Cap Al√©atoire (3):</strong> Change √† la fois la position et le cap de l'avion</li>
                    <li><strong>Afficher/Masquer R√©ponse :</strong> Montre ou cache les valeurs r√©elles</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="instructions">
        <p>Lyc√©e professionnel Roger Claustres - renaud.boulier@ac-clermont.fr</p>
    </div>
    
    <script>
        let imgNDcadre, imgNDmaquette, imgNDrose, imgtraicap;
        let flecheNDDouble, flecheNDSimple, imgNDB, imgPlane;
        let rose = 0;
        let QDR1, QDR3, QDM, QDM1, GT, GT1;
        let mx1, mx2, my1, my2, mmx, mmy;
        let rot;
        let reponse = false;
        let baliseLH, baliseRH, avion, avion1;
        let isMobile = false;
        let imagesLoaded = false;
        let imagesToLoad = 8;
        let imagesLoadedCount = 0;

        // Variables pour le contr√¥le continu du cap
        let rightMousePressed = false;
        let leftMousePressed = false;
        let lastUpdateTime = 0;
        const CAP_CHANGE_INTERVAL = 16;

        // Variables pour le contr√¥le mobile
        let capPlusPressed = false;
        let capMoinsPressed = false;

        // Variables pour le zoom et d√©placement
        let zoomScale = 1.0;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let lastTouchX, lastTouchY;
        let lastTouchDistance = 0;

        // Variable pour contr√¥ler le d√©placement de l'avion (d√©sactiv√© sur mobile)
        let aircraftMoving = false;

        let canvas;

        // Variables pour la gestion de l'orientation
        let isPortrait = true;

        function preload() {
            imgNDcadre = loadImage('NDcadre.png');
            imgNDmaquette = loadImage('NDmaquette.png');
            imgNDrose = loadImage('NDrose.png');
            flecheNDDouble = loadImage('NDDouble.png');
            flecheNDSimple = loadImage('NDSimple.png');
            imgNDB = loadImage('NDB.png');
            imgPlane = loadImage('plane.png');
            imgtraicap = loadImage('traicap.png');
        }

        
        function setup() {
            isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                      ('ontouchstart' in window) || 
                      (navigator.maxTouchPoints > 0);
            
            checkOrientation();
            
            window.addEventListener('orientationchange', checkOrientation);
            window.addEventListener('resize', checkOrientation);
            
            // Taille du canvas adaptative
            const canvasContainer = document.getElementById('canvasContainer');
            const containerRect = canvasContainer.getBoundingClientRect();
            
            let canvasWidth = containerRect.width;
            let canvasHeight = containerRect.height;
            
            canvas = createCanvas(canvasWidth, canvasHeight);
            canvas.parent('canvasContainer');
            canvas.style('display', 'block');
            canvas.style('cursor', 'default');
            
            canvas.elt.style.touchAction = 'pan-y';
            canvas.elt.style.webkitUserSelect = 'none';
            canvas.elt.style.userSelect = 'none';
            
            // Gestion des √©v√©nements tactiles - seulement pour le zoom
            canvas.elt.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.elt.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.elt.addEventListener('touchend', handleTouchEnd);
            
            baliseLH = createVector(0, -10);
            baliseRH = createVector(0, -10);
            imageMode(CENTER);
            rectMode(CENTER);
            textAlign(CENTER, CENTER);
            
            setupButtonEvents();
            
            // Position initiale de l'avion au centre
            mmx = width / 2;
            mmy = height / 2;
            
            if (isMobile) {
                zoomScale = 0.8;
            }
        }

        function checkOrientation() {
            isPortrait = window.innerHeight > window.innerWidth;
            const landscapeWarning = document.getElementById('landscapeWarning');
            const container = document.querySelector('.container');
            
            if (isMobile && !isPortrait) {
                if (landscapeWarning) landscapeWarning.style.display = 'flex';
                if (container) container.style.display = 'none';
            } else {
                if (landscapeWarning) landscapeWarning.style.display = 'none';
                if (container) container.style.display = 'flex';
            }
        }

        function handleTouchStart(e) {
            if (!canvas || !canvas.elt) return;
            
            // Sur mobile, on ne permet que le zoom, pas le d√©placement de l'avion
            if (isMobile) {
                if (e.touches.length === 2) {
                    // Zoom √† deux doigts
                    lastTouchDistance = dist(
                        e.touches[0].clientX, e.touches[0].clientY,
                        e.touches[1].clientX, e.touches[1].clientY
                    );
                    e.preventDefault();
                }
                // On ignore les touches simples pour √©viter le d√©placement de l'avion
            } else {
                // Sur ordinateur, on garde le comportement original
                const touch = e.touches[0];
                const rect = canvas.elt.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                const touchY = touch.clientY - rect.top;
                
                aircraftMoving = true;
                e.preventDefault();
                
                if (e.touches.length === 1) {
                    isDragging = true;
                    lastTouchX = touchX;
                    lastTouchY = touchY;
                    
                    mmx = touchX;
                    mmy = touchY;
                } else if (e.touches.length === 2) {
                    lastTouchDistance = dist(
                        e.touches[0].clientX, e.touches[0].clientY,
                        e.touches[1].clientX, e.touches[1].clientY
                    );
                }
            }
        }

        function handleTouchMove(e) {
            if (!canvas || !canvas.elt) return;
            
            if (isMobile) {
                // Sur mobile, on ne permet que le zoom
                if (e.touches.length === 2) {
                    let currentDistance = dist(
                        e.touches[0].clientX, e.touches[0].clientY,
                        e.touches[1].clientX, e.touches[1].clientY
                    );
                    
                    let zoomFactor = currentDistance / lastTouchDistance;
                    zoomScale *= zoomFactor;
                    zoomScale = constrain(zoomScale, 0.5, 3.0);
                    
                    lastTouchDistance = currentDistance;
                    e.preventDefault();
                }
                // On ignore les mouvements √† un doigt pour √©viter le d√©placement de l'avion
            } else {
                // Sur ordinateur, on garde le comportement original
                if (!aircraftMoving) {
                    return;
                }
                
                const touch = e.touches[0];
                const rect = canvas.elt.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                const touchY = touch.clientY - rect.top;

                if (e.touches.length === 1 && isDragging) {
                    mmx = touchX;
                    mmy = touchY;
                    e.preventDefault();
                } else if (e.touches.length === 2) {
                    let currentDistance = dist(
                        e.touches[0].clientX, e.touches[0].clientY,
                        e.touches[1].clientX, e.touches[1].clientY
                    );
                    
                    let zoomFactor = currentDistance / lastTouchDistance;
                    zoomScale *= zoomFactor;
                    zoomScale = constrain(zoomScale, 0.5, 3.0);
                    
                    lastTouchDistance = currentDistance;
                    e.preventDefault();
                }
            }
        }

        function handleTouchEnd(e) {
            if (!isMobile) {
                aircraftMoving = false;
                isDragging = false;
            }
            capPlusPressed = false;
            capMoinsPressed = false;
        }

        function setupButtonEvents() {
            const randomBothBtn = document.getElementById('randomBothBtn');
            const toggleReponseBtn = document.getElementById('toggleReponseBtn');
            const capPlusBtn = document.getElementById('capPlus');
            const capMoinsBtn = document.getElementById('capMoins');
            
            if (capPlusBtn && isMobile) {
                capPlusBtn.addEventListener('click', function() {
                    rose = (rose + 5) % 360;
                });
                capPlusBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    capPlusPressed = true;
                }, {passive: false});
                capPlusBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    capPlusPressed = false;
                }, {passive: false});
            }
            
            if (capMoinsBtn && isMobile) {
                capMoinsBtn.addEventListener('click', function() {
                    rose = (rose - 5 + 360) % 360;
                });
                capMoinsBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    capMoinsPressed = true;
                }, {passive: false});
                capMoinsBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    capMoinsPressed = false;
                }, {passive: false});
            }
            
            if (randomBothBtn) {
                randomBothBtn.addEventListener('click', randomBoth);
            }
            
            if (toggleReponseBtn) {
                toggleReponseBtn.addEventListener('click', toggleReponse);
            }
            
            // Gestion des modales
            document.getElementById('showTermsBtn').addEventListener('click', function() {
                document.getElementById('termsModal').classList.add('active');
            });
            
            document.getElementById('showButtonsBtn').addEventListener('click', function() {
                document.getElementById('buttonsModal').classList.add('active');
            });
            
            document.querySelectorAll('.closeBtn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').classList.remove('active');
                });
            });
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
            
            // Ajout de l'√©couteur d'√©v√©nement pour la touche "3"
            document.addEventListener('keydown', function(e) {
                if (e.key === '3') {
                    randomBoth();
                }
            });
        }

        function draw() {
            background(255);
            
            updateCapContinuous();

            if (!isMobile && leftMousePressed) {
                updateAircraftPosition();
            }

            push();
            translate(offsetX, offsetY);
            scale(zoomScale);

            let NDX, NDY, NDBX1, NDBY1, NDBX2, NDBY2;
            
            if (isMobile) {
                NDX = width * 0.35;
                NDY = height * 0.4;
                NDBX1 = width * 0.75;
                NDBY1 = height * 0.3;
                NDBX2 = width * 0.75;
                NDBY2 = height * 0.6;
            } else {
                NDX = width * 0.2;
                NDY = height * 0.4;
                NDBX1 = width * 0.6;
                NDBY1 = height * 0.3;
                NDBX2 = width * 0.8;
                NDBY2 = height * 0.6;
            }

            if (mmx === undefined || mmy === undefined) {
                mmx = width / 2;
                mmy = height / 2;
            }

            let cadreSize, roseSize, traicapSize;
            if (isMobile) {
                cadreSize = min(width, height) * 0.35;
                roseSize = min(width, height) * 0.3;
                traicapSize = min(width, height) * 0.35;
            } else {
                cadreSize = min(width, height) * 0.4;
                roseSize = min(width, height) * 0.35;
                traicapSize = min(width, height) * 0.4;
            }

            drawMainElements(NDX, NDY, cadreSize, roseSize, traicapSize, NDBX1, NDBY1, NDBX2, NDBY2);
            calculateNavigation(NDX, NDY, NDBX1, NDBY1, NDBX2, NDBY2);
            drawAircraft(NDX);
            drawBaliseNumbers(NDBX1, NDBY1, NDBX2, NDBY2);

            pop();
            updateAnswers();
        }

        function drawBaliseNumbers(NDBX1, NDBY1, NDBX2, NDBY2) {
            fill(255, 0, 0);
            textSize(isMobile ? 14 : 20);
            textAlign(CENTER, CENTER);
            textStyle(BOLD);
            text("1", NDBX1, NDBY1);
            text("2", NDBX2, NDBY2);
            textAlign(LEFT, CENTER);
            textStyle(NORMAL);
        }

        function updateCapContinuous() {
            let currentTime = millis();
            if (currentTime - lastUpdateTime > CAP_CHANGE_INTERVAL) {
                if (!isMobile && rightMousePressed) {
                    rose = (rose + 1) % 360;
                }
                if (isMobile) {
                    if (capPlusPressed) rose = (rose + 2) % 360;
                    if (capMoinsPressed) rose = (rose - 2 + 360) % 360;
                }
                lastUpdateTime = currentTime;
            }
        }

        function updateAircraftPosition() {
            if (!isMobile && leftMousePressed) {
                mmx = mouseX;
                mmy = mouseY;
            }
        }

        function drawMainElements(NDX, NDY, cadreSize, roseSize, traicapSize, NDBX1, NDBY1, NDBX2, NDBY2) {
            
                    image(imgNDcadre, NDX, NDY, cadreSize, cadreSize);
                    image(imgNDmaquette, NDX, NDY, cadreSize/10, cadreSize/10);

                    push();
                    translate(NDX, NDY);
                    rotate(radians(-rose));
                    image(imgNDrose, 0, 0, roseSize, roseSize); 
                    pop();
                   
                    image(imgtraicap, NDX, NDY, cadreSize, cadreSize); 
                    
                    push();
                    translate(NDX, NDY);
                    rotate(radians(QDM));  
                    image(flecheNDDouble, 0, 0, roseSize, roseSize);
                    pop();

                    push();
                    translate(NDX, NDY);
                    rotate(radians(QDM1));  
                    image(flecheNDSimple, 0, 0, roseSize, roseSize);
                    pop();

                    image(imgNDB, NDBX1, NDBY1);
                    image(imgNDB, NDBX2, NDBY2);
                    
                
        }

        
        function calculateNavigation(NDX, NDY, NDBX1, NDBY1, NDBX2, NDBY2) {
            let adjustedMmx = (mmx - offsetX) / zoomScale;
            let adjustedMmy = (mmy - offsetY) / zoomScale;

            mx1 = adjustedMmx - NDBX1;
            my1 = adjustedMmy - NDBY1;
            avion = createVector(mx1, my1);
            
            let angle1 = atan2(my1, mx1);
            QDR1 = degrees(angle1);
            if (QDR1 < 0) QDR1 += 360;
            
            QDM1 = (QDR1 + 180) % 360;
            GT = (QDM1 - rose + 360) % 360;

            mx2 = adjustedMmx - NDBX2;
            my2 = adjustedMmy - NDBY2;
            avion1 = createVector(mx2, my2);
            
            let angle2 = atan2(my2, mx2);
            QDR3 = degrees(angle2);
            if (QDR3 < 0) QDR3 += 360;
            
            QDM = (QDR3 + 180) % 360;
            GT1 = (QDM - rose + 360) % 360;
        }

        function drawAircraft(NDX) {
            let adjustedMmx = (mmx - offsetX) / zoomScale;
            let adjustedMmy = (mmy - offsetY) / zoomScale;

            push();
            translate(adjustedMmx, adjustedMmy);
            rotate(radians(rose));
            
                    image(imgPlane, 1, 5);
                
            pop();
        }

        
        function updateAnswers() {
            const reponsesBox = document.getElementById('reponsesBox');
            if (reponsesBox) {
                let txt = "";
                if (reponse) {
                    txt += "QDR1 = " + Math.round(QDR1) + "¬∞<br>";
                    txt += "QDM1 = " + Math.round(QDM1) + "¬∞<br>";
                    txt += "GT1 = " + Math.round(GT) + "¬∞<br>";
                    txt += "CAP = " + Math.round(rose) + "¬∞<br>";
                    txt += "QDR2 = " + Math.round(QDR3) + "¬∞<br>";
                    txt += "QDM2 = " + Math.round(QDM) + "¬∞<br>";
                    txt += "GT2 = " + Math.round(GT1) + "¬∞";
                } else {
                    txt += "QDR1 = ?<br>QDM1 = ?<br>GT1 = ?<br>CAP = ?<br>QDR2 = ?<br>QDM2 = ?<br>GT2 = ?";
                }
                reponsesBox.innerHTML = txt;
            }
        }

        function mousePressed() {
            if (!isMobile) {
                if (mouseButton === RIGHT) {
                    rightMousePressed = true;
                    lastUpdateTime = millis();
                    return false;
                } else if (mouseButton === LEFT) {
                    leftMousePressed = true;
                    mmx = mouseX;
                    mmy = mouseY;
                    return false;
                }
            }
            return false;
        }

        function mouseReleased() {
            if (!isMobile) {
                if (mouseButton === RIGHT) {
                    rightMousePressed = false;
                    return false;
                } else if (mouseButton === LEFT) {
                    leftMousePressed = false;
                    return false;
                }
            }
            return false;
        }

        function keyPressed() {
            if (key === '3') {
                randomBoth();
            }
        }

        function windowResized() {
            checkOrientation();
            
            const canvasContainer = document.getElementById('canvasContainer');
            const containerRect = canvasContainer.getBoundingClientRect();
            
            resizeCanvas(containerRect.width, containerRect.height);
        }

        function randomPosition() {
            let randomX = random(50, width - 50);
            let randomY = random(50, height - 50);
            
            mmx = randomX;
            mmy = randomY;
        }

        function randomCap() {
            rose = random(0, 359);
        }

        function randomBoth() {
            randomPosition();
            randomCap();
        }

        function toggleReponse() {
            reponse = !reponse;
            updateAnswers();
        }

        document.addEventListener('contextmenu', function(e) {
            if (e.target.tagName === 'CANVAS') {
                e.preventDefault();
                return false;
            }
        });

        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });

        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
        });

        document.addEventListener('gestureend', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
